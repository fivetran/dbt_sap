{{ config(enabled=var('sap_using_mara', True)) }}

with mara as (
    select *
    from {{ ref('stg_sap__mara') }}

{% set using_makt = var('sap_using_makt', True) %}
{% if using_makt %}
), makt as (
    select *
    from {{ ref('stg_sap__makt') }}
{% endif %}

), final as (
    select
        mara.mandt as client_id,
        mara.matnr as material_id,
        mara.retdelc as return_code_id,
        mara._sttpec_syncchg as _sttpec_syncchg,
        mara.sgt_covsa as segmentation_strategy_id,
        mara._sttpec_synctime as _sttpec_synctime,
        mara.size2 as second_size,
        mara.bwscl as source_supply_id,
        mara.liqdt as deletion_date,
        mara.compl as material_completion_level_id,
        mara.whstc as warehouse_storage_condition_id,
        mara.maxc_tol as overcapacity_toler,
        mara.ergew as allowed_packaging_weight,
        mara._sttpec_prdcat as _sttpec_prdcat,
        mara.kzwsm as units_measure_usage,
        mara.cotype as object_type_id,
        mara.bbtyp as assortment_list_type_id,
        mara.laeda as last_change_date,
        mara.ersda as created_date,
        mara.rdmhd as rounding_rule_sled,
        mara.picnum as supersession_chain_number,
        mara.herkl as country_of_origin_id,
        mara._vso_r_top_ind as _vso_r_top_ind,
        mara.magrv as matl_grp_pack_matls_id,
        mara.qgrp as quality_inspection_group_id,
        mara.fsh_sc_mid as material_conv_id,
        mara.behvo as container_requirements_id,
        mara.brgew as gross_weight,
        mara.mfrpn as manufacturer_part_number,
        mara.color_atinn as int_char_number_id,
        mara.kunnr as competitor_id,
        mara.qmpur as qm_in_procurement_is_active,
        mara.ipmipproduct as intellectual_property,
        mara.ferth as production_inspection_memo,
        mara.voleh as volume_uom_id,
        mara._vso_r_no_p_gvh as _vso_r_no_p_gvh,
        mara.mstav as x_distr_chain_status_id,
        mara.mtpos_mara as item_category_group_id,
        mara.kzumw as environmentally_relevant,
        mara.kzgvh as closed,
        mara.free_char as free_charact_value,
        mara.fiber_part1 as percentage_share_1,
        mara.eannr as ean_number,
        mara.brand_id as brand_id,
        mara.aeszn as document_change_no,
        mara.fiber_part2 as percentage_share_2,
        mara.ihivi as indicator_highly_viscous,
        mara.hutyp_dflt as standard_hu_type_id,
        mara.mbrsh as industry_sector_id,
        mara.textile_comp_ind as textile_composition_maintenance_active,
        mara.fiber_part3 as percentage_share_3,
        mara.dg_pack_status as dangerous_goods_packaging_status_id,
        mara.fiber_part4 as percentage_share_4,
        mara._vso_r_tilt_ind as _vso_r_tilt_ind,
        mara.mcond as material_condition_management,
        mara._vso_r_tol_b_ht as _vso_r_tol_b_ht,
        mara.fsh_mg_at2 as fashion_information_field_2,
        mara.fiber_part5 as percentage_share_5,
        mara.adprof as adjustment_profile_id,
        mara.mstde as valid_from_date,
        mara.volto as excess_volume_tol,
        mara.gtin_variant as global_trade_item_number_variant,
        mara.saisj as season_year,
        mara.zeiar as document_type,
        mara.prdha as product_hierarchy_id,
        mara.maxh as max_pack_height,
        mara.inhal as net_contents,
        mara.bwvor as procurement_rule_id,
        mara.groes as size_dimensions,
        mara.bflme as logistical_variants,
        mara.volum as volume,
        mara.sgt_stat as segmentation_status,
        mara.cadkz as cad_indicator,
        mara.qqtime as quarantine_period,
        mara._vso_r_pal_ovr_w as _vso_r_pal_ovr_w,
        mara.fiber_code3 as component_3_id,
        mara.fiber_code2 as component_2_id,
        mara.sprof as pricing_profile_variants,
        mara.fiber_code4 as component_4_id,
        mara.cwqtolgr as cw_tolerance_group_id,
        mara.kosch as product_allocation_id,
        mara.fiber_code5 as component_5_id,
        mara.xgchp as appr_batch_rec_req,
        mara.logunit as logistics_uom_id,
        mara.lvorm as df_at_client_level,
        mara.hoehe as height,
        mara.ergei as weight_uom_id,
        mara.begru as authorization_group,
        mara.ekwsl as purchasing_value_key_id,
        mara.gds_relevant as gds_relevant,
        mara.taklv as tax_classification_id,
        mara.datab as datab,
        mara.xchpf as batch_management,
        mara.care_code as care_code,
        mara.mhdrz as minimum_remaining_shelf_life,
        mara.oitrind as transfer_sign,
        mara.oihmtxgr as material_tax_group_id,
        mara.saity as rollout_in_season_id,
        mara.iprkz as period_ind_sled,
        mara._sttpec_country_ref as _sttpec_country_ref,
        mara.normt as industry_std_desc,
        mara.serlv as serialization_level,
        mara.kzkup as co_product,
        mara.mstdv as mstdv,
        mara.attyp as material_category,
        mara._dsd_sv_cnt_grp as _dsd_sv_cnt_grp,
        mara.stfak as stacking_factor,
        mara.tare_var as variable_tare_weight,
        mara.mfrnr as manufacturer_number_id,
        mara.allow_pmat_igno as variant_price_allowed,
        mara.imatn as fff_class,
        mara.profl as dg_indicator_profile_id,
        mara.tragr as transportation_group_id,
        mara.hutyp as handling_unit_type_id,
        mara.meins as base_uom_id,
        mara.bstme as order_uom_id,
        mara._vso_r_stack_no as _vso_r_stack_no,
        mara.cwqproc as cw_profile_cw_qty_id,
        mara.psm_code as protected_species_management_code_id,
        mara.blatt as page_number,
        mara._vso_r_pal_b_ht as _vso_r_pal_b_ht,
        mara._bev1_luldegrp as _bev1_luldegrp,
        mara._bev1_luleinh as _bev1_luleinh,
        mara.size1 as main_size,
        mara.maxc as maximum_capacity,
        mara.ntgew as net_weight,
        mara.saiso as season_category_id,
        mara.commodity as physical_commodity_id,
        mara.przus as product_composition,
        mara.cobjid as object_id,
        mara._vso_r_kzgvh_ind as _vso_r_kzgvh_ind,
        mara.anp as anp_code_id,
        mara.mprof as mfr_part_profile_id,
        mara.fsh_mg_at3 as fashion_information_field_3,
        mara.spart as division_id,
        mara.fsh_seaim as season_active_in_inventory_management,
        mara.formt as page_format_production_memo,
        mara.whmatgr as warehouse_material_group_id,
        mara.sled_bbd as expiration_date,
        mara.gennr as generic_material_id,
        mara.maxl as max_pack_length,
        mara.matkl as material_group_id,
        mara.nrfhg as qual_f_freegoodsdis,
        mara.serial as serial_number_profile_id,
        mara.matfi as material_is_locked,
        mara.qqtimeuom as time_quarantine_period_uom_id,
        mara.vpreh as comparison_price_unit,
        mara.zeivr as doc_version,
        mara.bmatn as int_material_number_id,
        mara.size1_atinn as size1_atinn,
        mara.loglev_reto as return_to_logistics_level_id,
        mara.fuelg as maximum_level_by_volume,
        mara.pilferable as pilferable,
        mara.kzrev as revision_level_assgd,
        mara._sttpec_sertype as _sttpec_sertype,
        mara._vso_r_pal_ind as _vso_r_pal_ind,
        mara.sgt_scope as segmentation_strategy_scope,
        mara.maxdim_uom as ment_uom_id,
        mara.nsnid as nato_item_identification_number,
        mara.etiar as label_type_id,
        mara.fsh_mg_at1 as fashion_information_field_1,
        mara.ervol as allowed_packaging_volume,
        mara.satnr as cross_plant_cm_id,
        mara.sgt_csgr as segmentation_structure_id,
        mara.blanz as number_sheets,
        mara.mtart as material_type_id,
        mara.etiag as labeling_matl_grpg_id,
        mara.fiber_code1 as component_1_id,
        mara.mfrgr as material_freight_group_id,
        mara._vso_r_stack_ind as _vso_r_stack_ind,
        mara.zeinr as document,
        mara.medium as medium_id,
        mara.cwqrel as catch_weight_relevant,
        mara.mhdhb as total_shelf_life,
        mara.vpsta as compl_maint_status,
        mara.wrkst as basic_material_id,
        mara.aeklk as net_change_costing,
        mara.stoff as hazardous_material_number_id,
        mara.packcode as packaging_code_id,
        mara.sgt_rel as segmentation_relevant,
        mara._vso_r_bot_ind as _vso_r_bot_ind,
        mara.breit as width,
        mara.adspc_spc as spare_part_class_code,
        mara.size2_atinn as size2_atinn,
        mara.weora as acceptance_at_origin,
        mara.inhbr as gross_contents,
        mara.fsh_sealv as indicator_use_season,
        mara.kzeff as assign_effect_vals,
        mara.plgtp as price_band_category_id,
        mara.pmata as pricing_reference_material_id,
        mara.rbnrm as catalog_profile_id,
        mara.meabm as dimension_uom_id,
        mara.cuobf as internal_object_number,
        mara._bev1_nestruccat as _bev1_nestruccat,
        mara.inhme as content_uom_id,
        mara.kznfm as follow_up_material,
        mara.hazmat as rel_hs,
        mara.mlgut as empties_bill_material,
        mara.wesch as number_gr_slips,
        mara._vso_r_pal_min_h as _vso_r_pal_min_h,
        mara.oigroupnam as td_product_group_id,
        mara.maxb as max_pack_width,
        mara.bismt as old_material_number,
        mara.disst as low_level_code,
        mara._sttpec_syncact as _sttpec_syncact,
        mara.bstat as creation_status_id,
        mara.animal_origin as cont_non_textile_parts_animal_origin,
        mara.etifo as label_form_id,
        mara.kzkfg as configurable_material,
        mara._dsd_sl_toltyp as _dsd_sl_toltyp,
        mara.fashgrd as fashion_grade_id,
        mara.cmeth as quantity_conversion_method,
        mara.rmatp as reference_matl_packing_id,
        mara.vhart as packaging_material_type_id,
        mara.mhdlp as storage_percentage,
        mara.ervoe as ervoe,
        mara.tempb as temperature_conditions_indicator_id,
        mara.ean11 as ean,
        mara._accgo_assgd_uom as _accgo_assgd_uom,
        mara._vso_r_quan_unit as _vso_r_quan_unit,
        mara.ernam as created_by,
        mara.gewto as excess_wt_tolerance,
        mara.numtp as ean_category_id,
        mara.labor as laboratory_design_office_id,
        mara.iloos as indicator_in_bulk_liquid,
        mara.cmrel as relevant_cm,
        mara._dsd_vc_group as _dsd_vc_group,
        mara.raube as storage_conditions_id,
        mara.extwg as external_material_group_id,
        mara.vabme as variable_purchase_order_unit,
        mara.laeng as length,
        mara.hndlcode as handling_indicator_id,
        mara._vso_r_pal_ovr_d as _vso_r_pal_ovr_d,
        mara.ps_smartform as form_name_id,
        mara.entar as deactivated_id,
        mara.pstat as maintenance_status,
        mara.color as color,
        mara.gewei as gewei,
        mara.aenam as changed_by,
        mara.mstae as cross_plant_material_status_id,
        mara.zeifo as page_format,
        mara._fivetran_deleted as _fivetran_deleted,
        mara._fivetran_synced as _fivetran_synced,
        mara._fivetran_sap_archived as _fivetran_sap_archived
        {{ 'makt.maktx' if using_makt else 'cast(null as ' ~ dbt.type_string() ~ ')' }} as material_description
    from mara

    {% if using_makt %}
    left join makt
        on mara.mandt = makt.mandt
        and mara.matnr = makt.matnr
        and makt.spras = 'e'
    {% endif %}

    where mara.mandt in ('{{ var("sales_and_procurement_mandt_var", ["800"]) | join("','") }}')
)

select *
from final